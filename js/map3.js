var locations = {
    lone_islands: {
        "Towns": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/blue.png",
            markers: [
                {
                    longitude: 863,
                    latitude: -232,
                    description: "Narrowhaven"
                },
                {
                    longitude: 154,
                    latitude: 365,
                    description: "Principle"
                },
                {
                    longitude: 286,
                    latitude: -141,
                    description: "Doorns Crossing"
                },
                {
                    longitude: -34,
                    latitude: -355,
                    description: "Bernstead"
                },
                {
                    longitude: -536,
                    latitude: 27,
                    description: "Lhoton"
                },
                {
                    longitude: -664,
                    latitude: 389,
                    description: "Praetorian Camp"
                },
                {
                    longitude: 899,
                    latitude: 382,
                    description: "Abandoned Settlement"
                }
            ]
        },
        "Dungeons": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/red.png",
            markers: [
                {
                    longitude: -548,
                    latitude: 555,
                    description: "Egyptian Pyramid Dungeon"
                },
                {
                    longitude: 422,
                    latitude: 345,
                    description: "Empty Dungeon (stairs down missing)"
                },
                {
                    longitude: 79,
                    latitude: 200,
                    description: "Bloodhaven, Vampire Dungeon"
                },
                {
                    longitude: -752,
                    latitude: -282,
                    description: "Empty Dungeon"
                },
                {
                    longitude: -618,
                    latitude: -377,
                    description: "The Underdark<br /><br />This is a huge dungeon that connects to the Narrowhaven sewers and an empty copy of the drow dungeon in the Calormen Empire (that also connects to another dungeon)."
                },
                {
                    longitude: -378,
                    latitude: -309,
                    description: "Empty Dungeon"
                },
                {
                    longitude: 969,
                    latitude: 368,
                    description: "Empty Dungeon"
                }
            ]
        },
        "Landmarks": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/gray.png",
            markers: [
                {
                    longitude: -1021,
                    latitude: -95,
                    description: "Apple Tree with a Corpse by it"
                },
                {
                    longitude: -400,
                    latitude: 175,
                    description: "Underwater Area (not accessible)"
                },
                {
                    longitude: -505,
                    latitude: 550,
                    description: "Egyptian Archeological Dig"
                },
                {
                    longitude: -1015,
                    latitude: -195,
                    description: "Brigand Town"
                },
                {
                    longitude: -218,
                    latitude: 293,
                    description: "Shipwreck"
                },
                {
                    longitude: -826,
                    latitude: -453,
                    description: "Shipwreck"
                },
                {
                    longitude: -90,
                    latitude: -384,
                    description: "Evil Estate<br /><br />Contains nasty spiders, butcher's cousins, nasty pumpkin heads, and smelly flowers, and a portal back to Narrowhaven bank."
                }
            ]
        },
        "Caves": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/orange.png",
            markers: [
                {
                    longitude: -878,
                    latitude: -72,
                    description: "Cave"
                },
                {
                    longitude: -826,
                    latitude: -190,
                    description: "Cave"
                },
                {
                    longitude: 509,
                    latitude: -34,
                    description: "Cave"
                },
                {
                    longitude: 608,
                    latitude: -261,
                    description: "Cave<br />Quest: Rats Everywere!"
                },
                {
                    longitude: 220,
                    latitude: -29,
                    description: "Cave<br />Quest: Duncan"
                },
                {
                    longitude: 63,
                    latitude: 25,
                    description: "Cave"
                },
                {
                    longitude: 100,
                    latitude: 152,
                    description: "Cave"
                },
                {
                    longitude: 347,
                    latitude: 105,
                    description: "Cave"
                },
                {
                    longitude: 49,
                    latitude: 297,
                    description: "Cave"
                },
                {
                    longitude: -566,
                    latitude: -90,
                    description: "Cave"
                },
                {
                    longitude: -997,
                    latitude: -288,
                    description: "Cave"
                },
                {
                    longitude: -825,
                    latitude: -427,
                    description: "Cave (Pirate Treasure)"
                },
                {
                    longitude: -352,
                    latitude: -198,
                    description: "Steelfang Den"
                },
                {
                    longitude: -551,
                    latitude: -479,
                    description: "Cave with Dungeon Walls"
                },
                {
                    longitude: -471,
                    latitude: -453,
                    description: "Cave"
                }
            ]
        },
        "Cemetaries": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/green.png",
            markers: [
                {
                    longitude: -50,
                    latitude: -454,
                    description: "Bernstead Cemetary<br /><br />Boss: Bone Daemon<br />Summoning Item: Gruesome Effigy<br />Where to Summon: In a coffin room downstairs from the cemetary.<br />Boss Difficulty: Hard<br />The boss hits as hard as a fire giant and has the casting capabilities comparable to an ancient lich. A good fighter and mage team can take it on with some difficulty."
                }
            ]
        }
    },
    calormen: {
        "Towns": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/blue.png",
            markers: [
                {
                    longitude: -600,
                    latitude: -158,
                    description: "New Tashbaan"
                },
                {
                    longitude: -1670,
                    latitude: 1102,
                    description: "Al Andrisat"
                },
                {
                    longitude: 361,
                    latitude: 727,
                    description: "Rashon"
                },
                {
                    longitude: 1116,
                    latitude: 1639,
                    description: "Lorinash"
                },
                {
                    longitude: 1663,
                    latitude: 595,
                    description: "Qular"
                },
                {
                    longitude: -1719,
                    latitude: 34,
                    description: "Telmisat"
                },
                {
                    longitude: 272,
                    latitude: -184,
                    description: "Jal"
                },
                {
                    longitude: 101,
                    latitude: -1147,
                    description: "Sulalim"
                },
                {
                    longitude: 1669,
                    latitude: -941,
                    description: "Unknown Town"
                },
                {
                    longitude: -408,
                    latitude: -730,
                    description: "Unpopulated Settlement"
                }
            ]
        },
        "Dungeons": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/red.png",
            markers: [
                {
                    longitude: 1207,
                    latitude: 955,
                    description: "Ice Barbarian Dungeon<br /><br />Boss: Odin<br />Summoning Item: Odin's Crown<br /> Where to Summon: In an area with a giant blue throne on the west side of the first level.<br />Boss Difficulty: Medium<br />Odin does no magic and hits moderately hard while using concussion blow. An experienced warrior can joust him easily."
                },
                {
                    longitude: -42,
                    latitude: 1189,
                    description: "Empty Dungeon"
                },
                {
                    longitude: -36,
                    latitude: 1294,
                    description: "Empty Dungeon"
                },
                {
                    longitude: -1282,
                    latitude: 198,
                    description: "Elemental Dungeon<br /><br />Boss: Gro'mud<br />Summoning Item: Mystic Mud<br />Where to Summon: In an area with a pond and ruined bookshelf at the end of the third level.<br />Boss Difficulty: Medium<br />A good fighter can joust the boss easily."
                },
                {
                    longitude: -1155,
                    latitude: -288,
                    description: "Spider Dungeon"
                },
                {
                    longitude: -931,
                    latitude: -758,
                    description: "Ophidian Dungeon (empty)"
                },
                {
                    longitude: -361,
                    latitude: -1583,
                    description: "Empty Dungeon"
                },
                {
                    longitude: 546,
                    latitude: -1543,
                    description: "Drow Dungeon"
                },
                {
                    longitude: 636,
                    latitude: -1267,
                    description: "Fire Dungeon<br /><br />Boss: Thor<br />Summoning Item: Mjolnir<br /> Where to Summon: In an area on the second level surrounded by lava partially covered in treasure.<br />Boss Difficulty: Hard<br />Thor does no magic but hits extremely hard and rapidly."
                },
                {
                    longitude: -1811,
                    latitude: 1420,
                    description: "Empty Dungeon"
                }
            ]
        },
        "Landmarks": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/gray.png",
            markers: [
                {
                    longitude: -442,
                    latitude: 850,
                    description: "Orc Outpost"
                },
                {
                    longitude: -1008,
                    latitude: -213,
                    description: "Brigand Camp"
                },
                {
                    longitude: -1951,
                    latitude: -355,
                    description: "Evil Mage Outpost"
                },
                {
                    longitude: -226,
                    latitude: -1111,
                    description: "Orc Town"
                },
                {
                    longitude: 390,
                    latitude: -1424,
                    description: "Lava Pit"
                },
                {
                    longitude: 1601,
                    latitude: -894,
                    description: "Terathan Camp"
                },
                {
                    longitude: -1406,
                    latitude: -836,
                    description: "Unpopulated Lighthouse"
                },
                {
                    longitude: 255,
                    latitude: 113,
                    description: "Unpopulated Fishing House"
                }
            ]
        },
        "Caves": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/orange.png",
            markers: [
                {
                    longitude: -1601,
                    latitude: -618,
                    description: "Elder Dragon's Lair"
                },
                {
                    longitude: -190,
                    latitude: -1497,
                    description: "Drow Refugee Town"
                },
                {
                    longitude: -33,
                    latitude: -1523,
                    description: "Drow Refugee Town"
                },
                {
                    longitude: -1365,
                    latitude: 1131,
                    description: "Cave"
                },
                {
                    longitude: -1183,
                    latitude: 1066,
                    description: "Cave"
                },
                {
                    longitude: -308,
                    latitude: 1196,
                    description: "Cave"
                },
                {
                    longitude: 250,
                    latitude: 1052,
                    description: "Cave"
                },
                {
                    longitude: 695,
                    latitude: 1148,
                    description: "Cave"
                },
                {
                    longitude: 1424,
                    latitude: 838,
                    description: "Cave"
                },
                {
                    longitude: 1620,
                    latitude: 681,
                    description: "Cave"
                },
                {
                    longitude: -637,
                    latitude: -450,
                    description: "Cave"
                },
                {
                    longitude: 383,
                    latitude: -1047,
                    description: "Cave"
                },
                {
                    longitude: 492,
                    latitude: -972,
                    description: "Cave"
                }
            ]
        },
        "Cemetaries": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/green.png",
            markers: [
                {
                    longitude: 1804,
                    latitude: 311,
                    description: "Qular Cemetary"
                },
                {
                    longitude: 139,
                    latitude: -114,
                    description: "Telmisat Cemetary"
                },
                {
                    longitude: -680,
                    latitude: -335,
                    description: "New Tashbaan Cemetary"
                },
                {
                    longitude: -422,
                    latitude: -644,
                    description: "Unpopulated Settlement Cemetary"
                },
                {
                    longitude: 1700,
                    latitude: -1363,
                    description: "Unknown Town Cemetary"
                }
            ]
        },
        "Shrines": {
            icon: "http://192.168.0.3/~squega/openlayers_test/images/icons/yellow.png",
            markers: [
                {
                    longitude: -1320,
                    latitude: 158,
                    description: "Shrine of Chaos"
                },
                {
                    longitude: -95,
                    latitude: 42,
                    description: "Shrine of Spirituality"
                },
                {
                    longitude: -1704,
                    latitude: -764,
                    description: "Shrine of Justice"
                },
                {
                    longitude: 1205,
                    latitude: 1145,
                    description: "Shrine of Honesty"
                },
                {
                    longitude: 1613,
                    latitude: -537,
                    description: "Shrine of Valor"
                },
                {
                    longitude: -663,
                    latitude: -1018,
                    description: "Shrine of Compassion"
                },
                {
                    longitude: -852,
                    latitude: -1411,
                    description: "Shrine of Honor"
                },
                {
                    longitude: -1056,
                    latitude: 1123,
                    description: "Shrine of Humility"
                }
            ]
        }
    }
};

function Map(dom_element, name, tiles_location, width, height, grouped_markers, places_dom_element) {
    var instance = this;

    this.dom_element = dom_element;    
    this.name = name;
    this.tiles_location = tiles_location;
    this.width = width;
    this.half_width = (width / 2);
    this.height = height;
    this.half_height = (height / 2)
    this.grouped_markers = grouped_markers;
    this.places_dom_element = places_dom_element;
    this.markers = [];
    
    this.base_layer = new OpenLayers.Layer.Zoomify(
        this.name, 
        this.tiles_location, 
        new OpenLayers.Size(this.width, this.height)
    );

    this.map = new OpenLayers.Map(this.dom_element.attr('id'), {
        controls: [],
        maxExtent: new OpenLayers.Bounds((0 - this.half_width), (0 - this.half_height), this.half_width, this.half_height),
        maxResolution: Math.pow(2, this.base_layer.numberOfTiers - 1),
        numZoomLevels: this.base_layer.numberOfTiers,
        units: 'pixels'
    });
    
    this.map.addLayer(this.base_layer);
    this.map.setBaseLayer(this.base_layer);

    this.map.setCenter(new OpenLayers.LonLat(0, 0), 0);
    
    if(typeof grouped_markers == 'object') {
        for(type_name in grouped_markers) {
            if(grouped_markers.hasOwnProperty(type_name)) {
                var marker_type =  grouped_markers[type_name];
                
                this.initializeMarkerType(type_name, marker_type.markers, marker_type.icon);
            }
        }
    }

    this.map.addControl(new OpenLayers.Control.Navigation());
	this.map.addControl(new OpenLayers.Control.PanZoomBar());
    this.map.addControl(new OpenLayers.Control.Attribution());    
    this.map.addControl(new OpenLayers.Control.MousePosition({
        //formatOutput: function(coordinates) {
        //    return instance.getUoCoordinates(coordinates, instance);
        //}
    }));
    
    this.setMapMoveEnd();

    this.map.zoomToMaxExtent();
};

Map.prototype.getUoCoordinates = function(coordinates, instance) {
    if(typeof instance == 'undefined') {
        instance = this;
    }
    
    var uo_longitude = instance.half_width + parseInt(coordinates.lon);
    var uo_latitude = instance.half_height - parseInt(coordinates.lat);

    return uo_longitude + ', ' + uo_latitude;
};

Map.prototype.initializeMarkerType = function(type_name, map_markers, icon_path) {
    var marker_size = new OpenLayers.Size(21, 33);
    var offset = new OpenLayers.Pixel(-(marker_size.w / 2), -marker_size.h);
    var icon = new OpenLayers.Icon(icon_path, marker_size, offset);

    var markers = new OpenLayers.Layer.Markers(type_name);

    for(index in map_markers) {
        if(map_markers.hasOwnProperty(index)) {
            var properties = map_markers[index];
            var marker = new OpenLayers.Marker(new OpenLayers.LonLat(properties.longitude, properties.latitude), icon.clone());
            
            marker.description = this.getUoCoordinates({lon: properties.longitude, lat: properties.latitude}) + '<br />' + properties.description;
            
            marker.place = new Place(marker, this.map);                                    
            
            this.setMarkerClick(marker);

            markers.addMarker(marker);
            this.markers.push(marker);
        }
    }

    this.map.addLayer(markers);
};

Map.prototype.setMarkerClick = function(marker) {
    var instance = this;

    marker.events.register("click", marker, function(event) {
        instance.map.addPopup(new OpenLayers.Popup.FramedCloud(
            type_name, 
            marker.lonlat, 
            new OpenLayers.Size(200, 200),
            marker.description,
            null,
            true,
            function(event) {                        
                marker.place.setUnclicked();                                             
            }                                    
        ), true);
        
        marker.place.setClicked();
        
        return false;
    }); 
};

Map.prototype.setMapMoveEnd = function() {
    var instance = this;
    
    instance.map.events.register('moveend', instance.map, function(event) {
        var screen_bounds = instance.map.getExtent();

        if(instance.markers.length > 0) {
            instance.places_dom_element.html('');
            
            for(index in instance.markers) {
                if(instance.markers.hasOwnProperty(index)) {
                    var marker = instance.markers[index];
    
                    if(screen_bounds.containsLonLat(marker.lonlat)) {
                        marker.place.bindEvents();
                    
                        instance.places_dom_element.append(marker.place.dom_element);
                    }
                }
            }
        }
    });
};

function Place(marker, map) {
    this.marker = marker;
    this.map = map;
    this.dom_element = $('<div><img src="' + marker.icon.url + '" />' +  marker.description + '</div><br />');
};

Place.prototype.bindEvents = function() {
    this.dom_element.bind('mouseover', {
        instance: this
    }, this.onMouseOver);
    
    this.dom_element.bind('mouseout', {
        instance: this
    }, this.onMouseOut);
    
    this.dom_element.bind('click', {
        instance: this
    }, this.onClick);
};

Place.prototype.onMouseOver = function(event) {
    var instance = event.data.instance;

    instance.dom_element.addClass('hovered');
};

Place.prototype.onMouseOut = function(event) {
    var instance = event.data.instance;
    var dom_element = instance.dom_element;
    
    dom_element.removeClass('hovered');
};

Place.prototype.setClicked = function(instance) {
    if(typeof instance == 'undefined') {
        instance = this;
    }
    
    instance.dom_element.siblings('.clicked').removeClass('clicked');
    
    instance.dom_element.addClass('clicked');
};

Place.prototype.setUnclicked = function(instance) {
    if(typeof instance == 'undefined') {
        instance = this;
    }
    
    instance.map.removePopup(instance.map.popups[0]);
    
    instance.dom_element.removeClass('clicked');
};

Place.prototype.onClick = function(event) {
    var instance = event.data.instance;
    var dom_element = instance.dom_element;
    
    if(!instance.dom_element.hasClass('clicked')) {
        instance.setClicked(instance);
    
        instance.marker.events.triggerEvent('click');
    }
    else {
        instance.setUnclicked(instance);
    }
};

var calormen_map;
var calormen_places;
var lone_islands_map;
var lone_islands_places;

var active_tab;
var visible_places;

function set_map_switch() {
    var calormen_container = $('#calormen_map');
    var lone_islands_container = $('#lone_islands_map');

    $('.map_tab').click(function(event) {
        event.preventDefault();
        
        //Remove the styling of the old active tab 
        active_tab.removeClass('active_tab');
        
        //Set the clicked tab as the new active one
        active_tab = $(this);
        
        //Give the new active tab the active styling
        active_tab.addClass('active_tab');
        
        var new_visible_places;
        
        switch($(this).text()) {
            case 'Calormen Empire':
                if(!calormen_container.is(':visible')) {
                    new_visible_places = calormen_places;
                
                    lone_islands_container.hide('fast', function() {
                        calormen_container.show();
                    });
                }
                break;
            case 'Lone Islands':
                if(!lone_islands_container.is(':visible')) {
                    new_visible_places = lone_islands_places;
                
                    calormen_container.hide('fast', function() {
                        lone_islands_container.show('fast', function() {
                            if(typeof lone_islands_map == 'undefined') {
                                lone_islands_map = new Map(
                                    lone_islands_container, 
                                    'Lone Islands', 
                                    'http://192.168.0.3/~squega/openlayers_test/images/tiles/lone_islands/',
                                    2304,
                                    1280,
                                    locations.lone_islands,
                                    lone_islands_places
                                );
                            }
                        });
                    });
                }
                break;
        }
        
        if(typeof new_visible_places != 'undefined') {
            //Close the current visible places
            visible_places.slideToggle('fast');
            
            //Open the new visible places
            new_visible_places.slideToggle('fast');
            
            //Set the new visible places as the current one
            visible_places = new_visible_places;
        }
        
        return false;
    });
};

$(document).ready(function() {
    calormen_places = $('#calormen_places');
    lone_islands_places = $('#lone_islands_places');
    
    active_tab = $('#calormen_tab');
    active_tab.addClass('active_tab');
    
    visible_places = calormen_places;

    calormen_map = new Map(
        $('#calormen_map'), 
        'Calormen Empire', 
        'http://192.168.0.3/~squega/openlayers_test/images/tiles/calormen/',
        5120,
        4096,
        locations.calormen,
        calormen_places
    );
    
    set_map_switch();
});